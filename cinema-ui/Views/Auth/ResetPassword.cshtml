@model cinema_ui.Controllers.ResetPasswordViewModel
@{
    ViewData["Title"] = "Reset Password";
    Layout = "_AuthLayout";
}

<div class="auth-container">
    <div class="auth-box">
        <div class="auth-logo">CINEMA</div>
        <h1 class="auth-title">Create new password</h1>
        <p class="auth-subtitle">Enter the code sent to <strong style="color: #fff;">@Model.Email</strong></p>

        @if (!string.IsNullOrEmpty(Model.ErrorMessage))
        {
            <div class="alert-danger">@Model.ErrorMessage</div>
        }

        <form asp-action="ResetPassword" method="post" class="auth-form">
            <input type="hidden" asp-for="UserId" />
            <input type="hidden" asp-for="Email" />
            <input type="hidden" asp-for="ResetCode" />
            
            <div class="form-group">
                <input type="text" 
                       asp-for="EnteredCode" 
                       class="code-input" 
                       placeholder="000000" 
                       maxlength="6" 
                       pattern="[0-9]{6}"
                       inputmode="numeric"
                       autocomplete="one-time-code"
                       required />
            </div>
            
            <div class="form-group">
                <input asp-for="NewPassword" type="password" class="form-control" placeholder="New password" required autocomplete="new-password" />
                <span asp-validation-for="NewPassword" class="text-danger"></span>
            </div>
            
            <div class="form-group">
                <input asp-for="ConfirmPassword" type="password" class="form-control" placeholder="Confirm new password" required autocomplete="new-password" />
                <span asp-validation-for="ConfirmPassword" class="text-danger"></span>
            </div>
            
            <button type="submit" class="btn-auth">Reset Password</button>
        </form>
        
        <p class="auth-footer" style="margin-top: 24px; color: #666; font-size: 12px;">
            Code expires in 15 minutes
        </p>
    </div>
</div>

<!-- Hidden data for EmailJS -->
<div id="emailData" 
     data-email="@Model.Email" 
     data-code="@Model.ResetCode"
     style="display: none;"></div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script src="https://cdn.jsdelivr.net/npm/@@emailjs/browser@4/dist/email.min.js"></script>
    <script>
        emailjs.init({ publicKey: "3JJbf4JB2-x-unn4F" });
        
        document.addEventListener('DOMContentLoaded', function() {
            const dataEl = document.getElementById('emailData');
            const email = dataEl.dataset.email;
            const code = dataEl.dataset.code;
            
            if (email && code) {
                emailjs.send('service_qz6sbsp', 'template_reset', {
                    to_email: email,
                    reset_code: code
                }).then(function() {
                    console.log('Reset email sent');
                }).catch(function(err) {
                    console.error('Email failed:', err);
                });
            }
        });
        
        // Auto-format code input
        document.querySelector('.code-input')?.addEventListener('input', function(e) {
            e.target.value = e.target.value.replace(/\D/g, '').substring(0, 6);
        });
    </script>
}
