@model cinema_ui.Controllers.VerifyEmailViewModel
@{
    ViewData["Title"] = "Verify Email";
    Layout = "_AuthLayout";
}

<div class="auth-container">
    <div class="auth-box">
        <h1 class="auth-logo">CINEMA</h1>
        <h2 class="auth-title">Verify your email</h2>
        <p class="auth-subtitle">We sent a code to <strong>@Model.Email</strong></p>

        @if (!string.IsNullOrEmpty(Model.ErrorMessage))
        {
            <div class="alert-danger">@Model.ErrorMessage</div>
        }
        
        @if (TempData["ResendMessage"] != null)
        {
            <div class="alert-success">@TempData["ResendMessage"]</div>
        }

        <form asp-action="VerifyEmail" method="post" class="auth-form">
            <input type="hidden" asp-for="UserId" />
            <input type="hidden" asp-for="Email" />
            <input type="hidden" asp-for="VerificationCode" />
            <input type="hidden" asp-for="Username" />
            
            <div class="form-group">
                <label>Verification Code</label>
                <input type="text" 
                       asp-for="EnteredCode" 
                       class="code-input" 
                       placeholder="000000" 
                       maxlength="6" 
                       pattern="[0-9]{6}"
                       inputmode="numeric"
                       autocomplete="one-time-code"
                       required />
            </div>
            
            <button type="submit" class="btn-auth">Verify Email</button>
        </form>
        
        <p class="auth-footer" style="margin-top: 16px;">
            <small style="color: hsl(var(--muted-foreground));">Code expires in 15 minutes</small>
        </p>
        
        <div class="divider">or</div>
        
        <form asp-action="ResendVerification" method="post">
            <input type="hidden" name="userId" value="@Model.UserId" />
            <button type="submit" class="btn-auth btn-auth-secondary">Resend Code</button>
        </form>
    </div>
</div>

<!-- Hidden data for EmailJS -->
<div id="emailData" 
     data-email="@Model.Email" 
     data-code="@Model.VerificationCode" 
     data-username="@Model.Username"
     style="display: none;"></div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/@@emailjs/browser@4/dist/email.min.js"></script>
    <script>
        emailjs.init({ publicKey: "3JJbf4JB2-x-unn4F" });
        
        document.addEventListener('DOMContentLoaded', function() {
            const dataEl = document.getElementById('emailData');
            const email = dataEl.dataset.email;
            const code = dataEl.dataset.code;
            const username = dataEl.dataset.username || 'there';
            
            if (email && code) {
                emailjs.send('service_qz6sbsp', 'template_9r07mb9', {
                    to_email: email,
                    to_name: username,
                    verification_code: code
                }).then(function() {
                    console.log('Verification email sent');
                }).catch(function(err) {
                    console.error('Email failed:', err);
                });
            }
        });
        
        // Auto-format code input
        document.querySelector('.code-input')?.addEventListener('input', function(e) {
            e.target.value = e.target.value.replace(/\D/g, '').substring(0, 6);
        });
    </script>
}
