@model cinema_ui.Controllers.MovieDetailViewModel
@{
    ViewData["Title"] = Model.Movie.Title;
    Layout = "_Layout";
    var hasBackdrop = !string.IsNullOrEmpty(Model.Movie.BackdropUrl);
}

@if (hasBackdrop)
{
    <div class="movie-detail-backdrop" style="background-image: url('@Model.Movie.BackdropUrl');"></div>
    <div class="movie-detail-backdrop-fade"></div>
}

<div class="netflix-container">
    <div class="movie-detail-content @(hasBackdrop ? "with-backdrop" : "")">
        <div class="content-section" style="@(hasBackdrop ? "" : "margin-top: 100px;")">
            <div class="grid" style="grid-template-columns: 300px 1fr; gap: var(--spacing-xl); margin-bottom: var(--spacing-2xl);">
                <div>
                    @if (!string.IsNullOrEmpty(Model.Movie.PosterUrl))
                    {
                        <img src="@Model.Movie.PosterUrl" alt="@Model.Movie.Title" style="width: 100%; border-radius: calc(var(--radius) + 2px); box-shadow: var(--shadow-lg);" />
                    }
                    else
                    {
                        <div style="width: 100%; aspect-ratio: 2/3; background: hsl(var(--muted)); border-radius: calc(var(--radius) + 2px); display: flex; align-items: center; justify-content: center; color: hsl(var(--muted-foreground));">
                            <span style="font-size: 3rem;">üé¨</span>
                        </div>
                    }
                </div>
                
                <div>
                    <h1>@Model.Movie.Title</h1>
                    <div class="mb-4">
                        <p><strong>Genre:</strong> @Model.Movie.Genre</p>
                        <p><strong>Rating:</strong> @Model.Movie.Rating</p>
                        <p><strong>Duration:</strong> @Model.Movie.DurationMinutes minutes</p>
                        <p><strong>Release Date:</strong> @Model.Movie.ReleaseDate.ToString("MMMM dd, yyyy")</p>
                        <p><strong>Director:</strong> @Model.Movie.Director</p>
                    </div>
                    <div class="mb-4">
                        <h3>Description</h3>
                        <p class="text-muted" style="line-height: 1.7;">@Model.Movie.Description</p>
                    </div>
                    @if (!string.IsNullOrEmpty(Model.Movie.TrailerUrl))
                    {
                        <button type="button" class="btn btn-primary" onclick="openTrailerModal('@Html.Raw(Model.Movie.TrailerUrl)')" style="margin-top: var(--spacing-md);">
                            <span>üé¨</span> Watch Trailer
                        </button>
                    }
                </div>
            </div>

            <h2 class="section-title">Available Screenings</h2>
            
            @if (Model.AvailableDates.Any())
            {
                <!-- Filters Section -->
                <div class="screening-filters" style="margin-bottom: var(--spacing-xl); padding: var(--spacing-lg); background: hsl(var(--card)); border-radius: var(--radius); border: 1px solid hsl(var(--border));">
                    <div style="display: flex; flex-wrap: wrap; gap: var(--spacing-lg); align-items: flex-start;">
                        <!-- Date Filter Pills -->
                        <div style="flex: 1; min-width: 300px;">
                            <label class="label" style="margin-bottom: var(--spacing-sm); display: block;">Select Date</label>
                            <div style="display: flex; flex-wrap: wrap; gap: var(--spacing-xs);">
                                <a asp-action="MovieDetail" asp-route-id="@Model.Movie.Id" asp-route-theaterId="@Model.SelectedTheaterId"
                                   class="date-pill @(Model.SelectedDate == null ? "active" : "")"
                                   style="padding: var(--spacing-sm) var(--spacing-md); border-radius: var(--radius); @(Model.SelectedDate == null ? "background: hsl(var(--primary)); color: hsl(var(--primary-foreground));" : "background: hsl(var(--muted)); color: hsl(var(--muted-foreground));") text-decoration: none; font-size: 0.875rem; white-space: nowrap;">
                                    All Dates
                                </a>
                                @foreach (var date in Model.AvailableDates.Take(7))
                                {
                                    var isSelected = Model.SelectedDate.HasValue && Model.SelectedDate.Value.Date == date.Date;
                                    var isToday = date.Date == DateTime.Today;
                                    var displayText = isToday ? "Today" : (date.Date == DateTime.Today.AddDays(1) ? "Tomorrow" : date.ToString("ddd, MMM d"));
                                    <a asp-action="MovieDetail" asp-route-id="@Model.Movie.Id" asp-route-date="@date.ToString("yyyy-MM-dd")" asp-route-theaterId="@Model.SelectedTheaterId"
                                       class="date-pill @(isSelected ? "active" : "")"
                                       style="padding: var(--spacing-sm) var(--spacing-md); border-radius: var(--radius); @(isSelected ? "background: hsl(var(--primary)); color: hsl(var(--primary-foreground));" : "background: hsl(var(--muted)); color: hsl(var(--muted-foreground));") text-decoration: none; font-size: 0.875rem; white-space: nowrap;">
                                        @displayText
                                    </a>
                                }
                            </div>
                        </div>
                        
                        <!-- Theater Filter -->
                        @if (Model.AvailableTheaters.Count > 1)
                        {
                            <div style="min-width: 200px;">
                                <label class="label" style="margin-bottom: var(--spacing-sm); display: block;">Theater</label>
                                <select id="theaterFilter" class="form-control" onchange="filterByTheater(this.value)" style="width: 100%;">
                                    <option value="">All Theaters</option>
                                    @foreach (var theater in Model.AvailableTheaters)
                                    {
                                        if (Model.SelectedTheaterId == theater.Id)
                                        {
                                            <option value="@theater.Id" selected>@theater.Name</option>
                                        }
                                        else
                                        {
                                            <option value="@theater.Id">@theater.Name</option>
                                        }
                                    }
                                </select>
                            </div>
                        }
                    </div>
                    
                    @if (Model.SelectedDate.HasValue || Model.SelectedTheaterId.HasValue)
                    {
                        <div style="margin-top: var(--spacing-md);">
                            <a asp-action="MovieDetail" asp-route-id="@Model.Movie.Id" class="btn btn-sm btn-secondary">
                                ‚úï Clear Filters
                            </a>
                        </div>
                    }
                </div>
            }
            
            @if (Model.GroupedScreenings.Any())
            {
                @foreach (var dateGroup in Model.GroupedScreenings)
                {
                    var isToday = dateGroup.Key.Date == DateTime.Today;
                    var dateLabel = isToday ? "Today" : (dateGroup.Key.Date == DateTime.Today.AddDays(1) ? "Tomorrow" : dateGroup.Key.ToString("dddd, MMMM d"));
                    
                    <div class="screening-date-group" style="margin-bottom: var(--spacing-xl);">
                        <h3 style="margin-bottom: var(--spacing-md); color: hsl(var(--primary)); font-size: 1.125rem;">
                            üìÖ @dateLabel
                        </h3>
                        <div class="screenings-grid">
                            @foreach (var screening in dateGroup.Value)
                            {
                                <div class="screening-card screening-time-card">
                                    <div class="screening-info">
                                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: var(--spacing-sm);">
                                            <div>
                                                <p class="screening-time-large">@screening.ShowTime.ToString("HH:mm")</p>
                                                <p class="screening-theater">@screening.TheaterName</p>
                                            </div>
                                            <span class="screening-price-badge">$@screening.Price.ToString("F2")</span>
                                        </div>
                                        <p class="screening-seats" style="margin-bottom: var(--spacing-md);">
                                            üéüÔ∏è @screening.AvailableSeats seats available
                                        </p>
                                        @if (screening.AvailableSeats > 0)
                                        {
                                            <a asp-action="SelectSeats" asp-route-screeningId="@screening.Id" class="btn btn-primary" style="width: 100%;">Select Seats</a>
                                        }
                                        else
                                        {
                                            <button class="btn btn-secondary" style="width: 100%;" disabled>Sold Out</button>
                                        }
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                }
            }
            else if (Model.SelectedDate.HasValue || Model.SelectedTheaterId.HasValue)
            {
                <div class="empty-state">
                    <h3>No screenings match your filters</h3>
                    <p>Try selecting a different date or theater.</p>
                    <a asp-action="MovieDetail" asp-route-id="@Model.Movie.Id" class="btn btn-primary" style="margin-top: var(--spacing-md);">Show All Screenings</a>
                </div>
            }
            else
            {
                <div class="empty-state">
                    <h3>No screenings available</h3>
                    <p>There are no screenings scheduled for this movie at this time.</p>
                </div>
            }
        </div>
    </div>
</div>

@if (!string.IsNullOrEmpty(Model.Movie.TrailerUrl))
{
    <!-- Trailer Modal -->
    <div id="trailerModal" class="trailer-modal" onclick="closeTrailerModal(event)">
        <div class="trailer-modal-content">
            <button type="button" class="trailer-close-btn" onclick="closeTrailerModal(event)">&times;</button>
            <div class="trailer-video-container">
                <iframe id="trailerFrame" 
                        src="" 
                        frameborder="0" 
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                        allowfullscreen></iframe>
            </div>
        </div>
    </div>
    
    @section Scripts {
        <script>
            function filterByTheater(theaterId) {
                const url = new URL(window.location.href);
                if (theaterId) {
                    url.searchParams.set('theaterId', theaterId);
                } else {
                    url.searchParams.delete('theaterId');
                }
                window.location.href = url.toString();
            }
            
            function getYouTubeEmbedUrl(url) {
                let videoId = '';
                
                if (url.includes('youtu.be/')) {
                    videoId = url.split('youtu.be/')[1].split('?')[0];
                } else if (url.includes('youtube.com/watch')) {
                    const urlParams = new URLSearchParams(url.split('?')[1]);
                    videoId = urlParams.get('v');
                } else if (url.includes('youtube.com/embed/')) {
                    videoId = url.split('embed/')[1].split('?')[0];
                }
                
                return videoId ? `https://www.youtube.com/embed/${videoId}?autoplay=1&rel=0` : url;
            }
            
            function openTrailerModal(url) {
                const modal = document.getElementById('trailerModal');
                const iframe = document.getElementById('trailerFrame');
                
                if (modal && iframe) {
                    iframe.src = getYouTubeEmbedUrl(url);
                    modal.classList.add('active');
                    document.body.style.overflow = 'hidden';
                }
            }
            
            function closeTrailerModal(event) {
                if (event.target.classList.contains('trailer-modal') || 
                    event.target.classList.contains('trailer-close-btn')) {
                    const modal = document.getElementById('trailerModal');
                    const iframe = document.getElementById('trailerFrame');
                    
                    if (modal) {
                        modal.classList.remove('active');
                        document.body.style.overflow = '';
                    }
                    if (iframe) {
                        iframe.src = '';
                    }
                }
            }
            
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    const modal = document.getElementById('trailerModal');
                    if (modal && modal.classList.contains('active')) {
                        closeTrailerModal({ target: modal });
                    }
                }
            });
        </script>
    }
}
else
{
    @section Scripts {
        <script>
            function filterByTheater(theaterId) {
                const url = new URL(window.location.href);
                if (theaterId) {
                    url.searchParams.set('theaterId', theaterId);
                } else {
                    url.searchParams.delete('theaterId');
                }
                window.location.href = url.toString();
            }
        </script>
    }
}
