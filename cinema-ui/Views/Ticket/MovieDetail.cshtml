@model cinema_ui.Controllers.MovieDetailViewModel
@{
    ViewData["Title"] = Model.Movie.Title;
    Layout = "_Layout";
    var hasBackdrop = !string.IsNullOrEmpty(Model.Movie.BackdropUrl);
}

@if (hasBackdrop)
{
    <div class="movie-detail-backdrop" style="background-image: url('@Model.Movie.BackdropUrl');"></div>
    <div class="movie-detail-backdrop-fade"></div>
}

<div class="netflix-container">
    <div class="movie-detail-content @(hasBackdrop ? "with-backdrop" : "")">
        <div class="content-section" style="@(hasBackdrop ? "" : "margin-top: 100px;")">
            <div class="grid" style="grid-template-columns: 300px 1fr; gap: var(--spacing-xl); margin-bottom: var(--spacing-2xl);">
                <div>
                    @if (!string.IsNullOrEmpty(Model.Movie.PosterUrl))
                    {
                        <img src="@Model.Movie.PosterUrl" alt="@Model.Movie.Title" style="width: 100%; border-radius: calc(var(--radius) + 2px); box-shadow: var(--shadow-lg);" />
                    }
                    else
                    {
                        <div style="width: 100%; aspect-ratio: 2/3; background: hsl(var(--muted)); border-radius: calc(var(--radius) + 2px); display: flex; align-items: center; justify-content: center; color: hsl(var(--muted-foreground));">
                            <span style="font-size: 3rem;">ðŸŽ¬</span>
                        </div>
                    }
                </div>
                
                <div>
                    <h1>@Model.Movie.Title</h1>
                    <div class="mb-4">
                        <p><strong>Genre:</strong> @Model.Movie.Genre</p>
                        <p><strong>Rating:</strong> @Model.Movie.Rating</p>
                        <p><strong>Duration:</strong> @Model.Movie.DurationMinutes minutes</p>
                        <p><strong>Release Date:</strong> @Model.Movie.ReleaseDate.ToString("MMMM dd, yyyy")</p>
                        <p><strong>Director:</strong> @Model.Movie.Director</p>
                    </div>
                    <div class="mb-4">
                        <h3>Description</h3>
                        <p class="text-muted" style="line-height: 1.7;">@Model.Movie.Description</p>
                    </div>
                    @if (!string.IsNullOrEmpty(Model.Movie.TrailerUrl))
                    {
                        <button type="button" class="btn btn-primary" onclick="openTrailerModal('@Html.Raw(Model.Movie.TrailerUrl)')" style="margin-top: var(--spacing-md);">
                            <span>ðŸŽ¬</span> Watch Trailer
                        </button>
                    }
                </div>
            </div>

            <h2 class="section-title">Available Screenings</h2>
            @if (Model.Screenings.Any())
            {
                <div class="screenings-grid">
                    @foreach (var screening in Model.Screenings)
                    {
                        <div class="screening-card">
                            @if (!string.IsNullOrEmpty(screening.MoviePosterUrl))
                            {
                                <div class="screening-poster">
                                    <img src="@screening.MoviePosterUrl" alt="@screening.MovieTitle" loading="lazy" 
                                         onerror="this.onerror=null; this.parentElement.innerHTML='<div class=\'movie-placeholder\'><span>ðŸŽ¬</span></div>';" />
                                </div>
                            }
                            else if (!string.IsNullOrEmpty(Model.Movie.PosterUrl))
                            {
                                <div class="screening-poster">
                                    <img src="@Model.Movie.PosterUrl" alt="@screening.MovieTitle" loading="lazy" 
                                         onerror="this.onerror=null; this.parentElement.innerHTML='<div class=\'movie-placeholder\'><span>ðŸŽ¬</span></div>';" />
                                </div>
                            }
                            else
                            {
                                <div class="screening-poster">
                                    <div class="movie-placeholder">
                                        <span>ðŸŽ¬</span>
                                    </div>
                                </div>
                            }
                            <div class="screening-info">
                                <h3 class="screening-movie">@screening.TheaterName</h3>
                                <p class="screening-time">@screening.ShowTime.ToString("MMM dd, yyyy HH:mm")</p>
                                <p class="screening-price">$@screening.Price.ToString("F2")</p>
                                <p class="screening-seats">@screening.AvailableSeats seats available</p>
                                @if (screening.AvailableSeats > 0)
                                {
                                    <a asp-action="SelectSeats" asp-route-screeningId="@screening.Id" class="btn btn-primary" style="width: 100%; margin-top: var(--spacing-md);">Select Seats</a>
                                }
                                else
                                {
                                    <button class="btn btn-secondary" style="width: 100%; margin-top: var(--spacing-md);" disabled>Sold Out</button>
                                }
                            </div>
                        </div>
                    }
                </div>
            }
            else
            {
                <div class="empty-state">
                    <h3>No screenings available</h3>
                    <p>There are no screenings scheduled for this movie at this time.</p>
                </div>
            }
        </div>
    </div>
</div>

@if (!string.IsNullOrEmpty(Model.Movie.TrailerUrl))
{
    <!-- Trailer Modal -->
    <div id="trailerModal" class="trailer-modal" onclick="closeTrailerModal(event)">
        <div class="trailer-modal-content">
            <button type="button" class="trailer-close-btn" onclick="closeTrailerModal(event)">&times;</button>
            <div class="trailer-video-container">
                <iframe id="trailerFrame" 
                        src="" 
                        frameborder="0" 
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                        allowfullscreen></iframe>
            </div>
        </div>
    </div>
    
    @section Scripts {
        <script>
            function getYouTubeEmbedUrl(url) {
                let videoId = '';
                
                if (url.includes('youtu.be/')) {
                    videoId = url.split('youtu.be/')[1].split('?')[0];
                } else if (url.includes('youtube.com/watch')) {
                    const urlParams = new URLSearchParams(url.split('?')[1]);
                    videoId = urlParams.get('v');
                } else if (url.includes('youtube.com/embed/')) {
                    videoId = url.split('embed/')[1].split('?')[0];
                }
                
                return videoId ? `https://www.youtube.com/embed/${videoId}?autoplay=1&rel=0` : url;
            }
            
            function openTrailerModal(url) {
                const modal = document.getElementById('trailerModal');
                const iframe = document.getElementById('trailerFrame');
                
                if (modal && iframe) {
                    iframe.src = getYouTubeEmbedUrl(url);
                    modal.classList.add('active');
                    document.body.style.overflow = 'hidden';
                }
            }
            
            function closeTrailerModal(event) {
                if (event.target.classList.contains('trailer-modal') || 
                    event.target.classList.contains('trailer-close-btn')) {
                    const modal = document.getElementById('trailerModal');
                    const iframe = document.getElementById('trailerFrame');
                    
                    if (modal) {
                        modal.classList.remove('active');
                        document.body.style.overflow = '';
                    }
                    if (iframe) {
                        iframe.src = '';
                    }
                }
            }
            
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    const modal = document.getElementById('trailerModal');
                    if (modal && modal.classList.contains('active')) {
                        closeTrailerModal({ target: modal });
                    }
                }
            });
        </script>
    }
}
