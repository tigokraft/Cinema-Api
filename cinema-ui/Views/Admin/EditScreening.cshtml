@model cinema_ui.Models.AdminScreeningViewModel
@{
    ViewData["Title"] = "Edit Screening";
    Layout = "_AdminLayout";
}

<div class="page-header">
    <h2>Edit Screening</h2>
    <a asp-action="Screenings" class="btn btn-secondary">Back to Screenings</a>
</div>

@if (!string.IsNullOrEmpty(Model.ErrorMessage))
{
    <div class="alert alert-danger">@Model.ErrorMessage</div>
}

<div class="admin-form">
    <form asp-action="EditScreening" method="post">
        <input type="hidden" asp-for="Id" />
        
        <div class="form-section">
            <h4 style="color: var(--text-secondary); margin-bottom: 1rem;">Movie</h4>
            <div class="form-group">
                <label asp-for="MovieId">Movie</label>
                <select asp-for="MovieId" class="form-control" asp-items="@(new SelectList(Model.AvailableMovies, "Id", "Title"))">
                    <option value="">Select a movie</option>
                </select>
                <span asp-validation-for="MovieId" class="text-danger"></span>
            </div>
        </div>
        
        <div class="form-section" style="margin-top: 2rem;">
            <h4 style="color: var(--text-secondary); margin-bottom: 1rem;">Theater & Room</h4>
            <div class="form-row" style="display: flex; gap: 1rem;">
                <div class="form-group" style="flex: 1;">
                    <label asp-for="TheaterId">Theater</label>
                    <select asp-for="TheaterId" class="form-control" id="theaterSelect">
                        <option value="">Select a theater</option>
                        @foreach (var theater in Model.AvailableTheaters)
                        {
                            var isSelected = Model.TheaterId == theater.Id;
                            var jsonOptions = new System.Text.Json.JsonSerializerOptions { PropertyNamingPolicy = System.Text.Json.JsonNamingPolicy.CamelCase };
                            <option value="@theater.Id" 
                                    data-rooms="@System.Text.Json.JsonSerializer.Serialize(theater.Rooms, jsonOptions)"
                                    selected="@isSelected">
                                @theater.Name (@theater.RoomCount rooms)
                            </option>
                        }


                    </select>
                    <span asp-validation-for="TheaterId" class="text-danger"></span>
                </div>
                
                <div class="form-group" style="flex: 1;">
                    <label asp-for="RoomId">Room</label>
                    <select asp-for="RoomId" class="form-control" id="roomSelect">
                        <option value="">Select a room</option>
                        @foreach (var room in Model.AvailableRooms)
                        {
                            var isRoomSelected = Model.RoomId == room.Id;
                            <option value="@room.Id" 
                                    data-capacity="@room.Capacity"
                                    selected="@isRoomSelected">
                                @room.Name (@room.Capacity seats)
                            </option>
                        }
                    </select>
                    <span asp-validation-for="RoomId" class="text-danger"></span>
                </div>
            </div>
        </div>
        
        <div class="form-section" style="margin-top: 2rem;">
            <h4 style="color: var(--text-secondary); margin-bottom: 1rem;">Schedule</h4>
            <div class="form-row" style="display: flex; gap: 1rem;">
                <div class="form-group" style="flex: 1;">
                    <label asp-for="StartDate">Date</label>
                    <input asp-for="StartDate" type="date" class="form-control" />
                    <span asp-validation-for="StartDate" class="text-danger"></span>
                </div>
                
                <div class="form-group" style="flex: 1;">
                    <label asp-for="ShowTimesInput">Show Time (HH:mm)</label>
                    <input asp-for="ShowTimesInput" type="time" class="form-control" />
                    <span asp-validation-for="ShowTimesInput" class="text-danger"></span>
                </div>
            </div>
        </div>
        
        <div class="form-section" style="margin-top: 2rem;">
            <h4 style="color: var(--text-secondary); margin-bottom: 1rem;">Pricing</h4>
            <div class="form-group">
                <label asp-for="Price">Ticket Price ($)</label>
                <input asp-for="Price" type="number" step="0.01" min="0.01" class="form-control" style="max-width: 200px;" />
                <span asp-validation-for="Price" class="text-danger"></span>
            </div>
        </div>
        
        <div class="btn-group" style="margin-top: 2rem;">
            <button type="submit" class="btn btn-primary">Update Screening</button>
            <a asp-action="Screenings" class="btn btn-secondary">Cancel</a>
        </div>
    </form>
</div>

<script>
    const theaterSelect = document.getElementById('theaterSelect');
    const roomSelect = document.getElementById('roomSelect');
    const currentRoomId = @Model.RoomId;
    
    // Update rooms when theater changes
    theaterSelect.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        roomSelect.innerHTML = '<option value="">Select a room</option>';
        
        if (selectedOption.value) {
            const rooms = JSON.parse(selectedOption.dataset.rooms || '[]');
            rooms.forEach(room => {
                const option = document.createElement('option');
                option.value = room.id;
                option.textContent = `${room.name} (${room.capacity} seats)`;
                option.dataset.capacity = room.capacity;
                if (room.id === currentRoomId) {
                    option.selected = true;
                }
                roomSelect.appendChild(option);
            });
        }
    });
    
    // Initialize rooms on page load if theater is selected
    document.addEventListener('DOMContentLoaded', function() {
        if (theaterSelect.value && roomSelect.options.length <= 1) {
            // Rooms should already be populated from the model
        }
    });
</script>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
}
